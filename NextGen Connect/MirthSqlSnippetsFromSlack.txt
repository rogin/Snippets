2 Sept 2022
Anyone got some SQL that calculates average response time for messages for a channel?
with started as (select message_id, received_date from d_mm388 where connector_name = 'Source'),
     max_send_date as (select message_id, max(send_date) as final_send_date from d_mm388 group by message_id),
     per_message_start_end as (select s.message_id,
                                      s.received_date,
                                      msd.final_send_date,
                                      date_part('milliseconds', msd.final_send_date - s.received_date) as ms
                               from started s
                                        join max_send_date msd on msd.message_id = s.message_id)
select avg(ms)
from per_message_start_end as average_ms
--------------
2 Sept 2022
This is close but its still deleting too much content.
The goal is “do not delete anything for any connector on an errored message”
“for any not errored message, delete everything except the raw source message and source map”
WITH 
--this is a potentially infinite dataset, errors are rarely reprocessed and rarely pruned
--we have to date constrain it
--sniff check the EXPLAIN plan in PROD
--status is indexed with message_id this should be fast
errors as (
	select distinct message_id from d_mm11 mm
	where mm.status = 'E'
	AND mm.received_date <= now() - INTERVAL '1 minutes'	
	AND mm.received_date >= now() - INTERVAL '365 Days'
	order by message_id DESC
)
,candidates AS (
	SELECT metadata_id, mc.message_id, content_type, errors.message_id as err_msg_id
	--, data_type, status, error_code
	FROM d_mc11 mc
	INNER JOIN d_mm11 mm ON mm.id = mc.metadata_id AND mm.message_id = mc.message_id
	left outer join errors on errors.message_id = mc.message_id 
	WHERE 
		(
			(metadata_id = 0 AND content_type NOT IN (1,15))
			OR (metadata_id <> 0)
		)
		AND errors.message_id is null
		AND mm.received_date <= now() - INTERVAL '1 minutes'
		-- dont need a floor date since the raw pruner will run and take care of those
)
--select target.* FROM d_mc11 mc, candidates target
DELETE FROM d_mc11 mc USING candidates target
WHERE 
mc.message_id = target.message_id and mc.metadata_id=target.metadata_id and mc.content_type = target.content_type